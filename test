repeat wait() until getgenv().DEVICE_NAME ~= nil and getgenv().Key ~= nil

if not game:IsLoaded() then repeat game.Loaded:Wait() until game:IsLoaded() end

local request = (syn and syn.request) or request or (http and http.request) or http_request or (fluxus and fluxus.request) or getgenv().request
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local validKeys = {
    ["EMC-8Z5-AFHJK-ADAD0001"] = "https://title.ddshop-th.com/message.php",
    ["EMC-8Z5-AFHJK-AFGJKAK2"] = "https://title.ddshop-th.com/emc888/message.php",
    ["EMC-WEB-TEST-03"] = "https://example.com/api/device3"
}

local DEVICE_NAME = getgenv().DEVICE_NAME or "Unknown Device"
local USER_KEY = getgenv().Key

if not validKeys[USER_KEY] then
    player:Kick("❌ KEY ไม่ถูกต้อง")
    wait(2)
    while true do end
end

local API_URL = validKeys[USER_KEY]

-- ระบบ King Legacy
local function KingLegacySystem()
    local targetItems = {
        ["Hydra's Tail"] = 0,
        ["Sea King's Fin"] = 0,
        ["Sea's Wraith"] = 0,
        ["Sea King's Blood"] = 0
    }
    
    local targetFruits = {
        ["Dragon"] = 0,
        ["Gate"] = 0,
        ["Dough"] = 0,
        ["Toy"] = 0,
        ["Phoenix"] = 0
    }
    
    local function scanGUI()
        local playerGui = player:WaitForChild("PlayerGui")
        
        for itemName, _ in pairs(targetItems) do
            local guiElement = playerGui:FindFirstChild(itemName, true)
            if guiElement then
                local amountLabel = guiElement:FindFirstChild("Amount") or guiElement:FindFirstChildWhichIsA("TextLabel")
                if amountLabel then
                    targetItems[itemName] = tonumber(amountLabel.Text:match("%d+")) or 0
                end
            end
        end
        
        for fruitName, _ in pairs(targetFruits) do
            local guiElement = playerGui:FindFirstChild(fruitName .. "Fruit", true)
            if guiElement then
                local amountLabel = guiElement:FindFirstChild("Amount") or guiElement:FindFirstChildWhichIsA("TextLabel")
                if amountLabel then
                    targetFruits[fruitName] = tonumber(amountLabel.Text:match("%d+")) or 0
                end
            end
        end
    end
    
    while task.wait(10) do
        pcall(scanGUI)
        
        local data = {
            key = USER_KEY,
            device_name = DEVICE_NAME,
            player = player.Name,
            items = targetItems,
            fruits = targetFruits,
            online = true,
            script_running = true,
            timestamp = os.date("%Y-%m-%d %H:%M:%S"),
            game_type = "kinglegacy"
        }
        
        pcall(function()
            request({
                Url = API_URL,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = HttpService:JSONEncode(data)
            })
        end)
    end
end

-- ระบบ Grow a Garden
local function GrowAGardenSystem()
    local leaderstats = player:WaitForChild("leaderstats")
    local money = leaderstats:WaitForChild("Sheckles")
    
    local honeyValue = player:WaitForChild("PlayerGui"):WaitForChild("Honey_UI")
        :WaitForChild("Frame"):WaitForChild("TextLabel1"):WaitForChild("val")
    
    local function findPets()
        local pets = {}
        local locations = {player.Backpack, player.Character}
        
        for _, location in ipairs(locations) do
            if location then
                for _, item in ipairs(location:GetChildren()) do
                    if item:GetAttribute("ItemType") == "Pet" then
                        table.insert(pets, item.Name:gsub("%s%[.+%]", ""))
                    end
                end
            end
        end
        
        return pets
    end
    
    while task.wait(30) do
        local pets = pcall(findPets)
        
        local data = {
            key = USER_KEY,
            device_name = DEVICE_NAME,
            player = player.Name,
            money = money.Value,
            honey = honeyValue.Value,
            pets = pets,
            online = true,
            script_running = true,
            timestamp = os.date("%Y-%m-%d %H:%M:%S"),
            game_type = "growagarden"
        }
        
        pcall(function()
            request({
                Url = API_URL,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = HttpService:JSONEncode(data)
            })
        end)
    end
end

-- เริ่มทั้งสองระบบพร้อมกัน
task.spawn(function()
    pcall(KingLegacySystem)
end)

task.spawn(function()
    pcall(GrowAGardenSystem)
end)

print("เริ่มทำงานระบบติดตามข้อมูลทั้งสองเกมแล้ว")
